generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model School {
  id           Int      @id @default(autoincrement())
  name         String
  addressLine1 String?
  state        String?
  pinCode      String?
  country      String
  phone        String?
  email        String?
  timezone     String?  @default("UTC")
  logo         String?  // URL or path to school logo
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  admins        Admin[]
  students      Student[]
  teachers      Teacher[]
  parents       Parent[]
  grades        Grade[]
  classes       Class[]
  subjects      Subject[]
  lessons       Lesson[]
  exams         Exam[]
  assignments   Assignment[]
  results       Result[]
  attendances   Attendance[]
  events        Event[]
  announcements Announcement[]
  fees          Fee[]
  studentFees   StudentFee[]
  payments      Payment[]
}

model Admin {
  id        Int      @id @default(autoincrement())
  username  String
  email     String   @unique
  password  String
  role      String   @default("admin") // admin, teacher, student, parent
  schoolId  Int
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Optional links to existing records (for teacher/student/parent accounts)
  teacherId Int?
  teacher   Teacher? @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  studentId Int?
  student   Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parentId  Int?
  parent    Parent?  @relation(fields: [parentId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([username, schoolId])
  @@unique([teacherId])
  @@unique([studentId])
  @@unique([parentId])
}

model Student {
  id          Int          @id @default(autoincrement())
  username    String
  name        String
  surname     String
  email       String?
  phone       String?
  addressLine1 String?
  state       String?
  pinCode     String?
  country     String
  img         String?
  bloodType   String
  sex         UserSex
  createdAt   DateTime     @default(now())
  schoolId    Int
  school      School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classId     Int
  class       Class        @relation(fields: [classId], references: [id])
  gradeId     Int
  grade       Grade        @relation(fields: [gradeId], references: [id])
  studentParents StudentParent[]
  attendances Attendance[]
  results     Result[]
  studentFees StudentFee[]
  payments    Payment[]
  birthday    DateTime
  admin       Admin?       // Link to Admin account if exists

  @@unique([username, schoolId])
  @@unique([email, schoolId])
  @@unique([phone, schoolId])
}

model Teacher {
  id          Int       @id @default(autoincrement())
  username    String
  name        String
  surname     String
  email       String?
  phone       String?
  addressLine1 String?
  state       String?
  pinCode     String?
  country     String
  img         String?
  bloodType   String
  sex         UserSex
  createdAt   DateTime  @default(now())
  schoolId    Int
  school      School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subjects    Subject[]
  lessons     Lesson[]
  classes     Class[]
  birthday    DateTime
  admin       Admin?    // Link to Admin account if exists

  @@unique([username, schoolId])
  @@unique([email, schoolId])
  @@unique([phone, schoolId])
}

model Parent {
  id             Int             @id @default(autoincrement())
  username       String
  name           String
  surname        String
  email          String?
  phone          String
  addressLine1   String?
  state          String?
  pinCode        String?
  country        String
  createdAt      DateTime        @default(now())
  schoolId       Int
  school         School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentParents StudentParent[]
  admin          Admin?          // Link to Admin account if exists

  @@unique([username, schoolId])
  @@unique([email, schoolId])
  @@unique([phone, schoolId])
}

model StudentParent {
  id          Int                @id @default(autoincrement())
  studentId   Int
  student     Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parentId    Int
  parent      Parent             @relation(fields: [parentId], references: [id], onDelete: Cascade)
  relationship ParentRelationship
  createdAt   DateTime           @default(now())

  @@unique([studentId, parentId, relationship])
}

model Grade {
  id       Int    @id @default(autoincrement())
  level    Int
  schoolId Int
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  students Student[]
  classess Class[]
  fees     Fee[]

  @@unique([level, schoolId])
}

model Class {
  id            Int            @id @default(autoincrement())
  name          String
  capacity      Int
  schoolId      Int
  school        School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  supervisorId  Int?
  supervisor    Teacher?       @relation(fields: [supervisorId], references: [id])
  lessons       Lesson[]
  students      Student[]
  gradeId       Int
  grade         Grade          @relation(fields: [gradeId], references: [id])
  events        Event[]
  announcements Announcement[]

  @@unique([name, schoolId])
}

model Subject {
  id       Int       @id @default(autoincrement())
  name     String
  schoolId Int
  school   School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teachers Teacher[]
  lessons  Lesson[]

  @@unique([name, schoolId])
}

model Lesson {
  id        Int      @id @default(autoincrement())
  name      String
  day       Day
  startTime DateTime
  endTime   DateTime
  schoolId  Int
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  subjectId   Int
  subject     Subject      @relation(fields: [subjectId], references: [id])
  classId     Int
  class       Class        @relation(fields: [classId], references: [id])
  teacherId   Int
  teacher     Teacher      @relation(fields: [teacherId], references: [id])
  exams       Exam[]
  assignments Assignment[]
  attendances Attendance[]
}

model Exam {
  id        Int      @id @default(autoincrement())
  title     String
  startTime DateTime
  endTime   DateTime
  schoolId  Int
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  lessonId Int
  lesson   Lesson   @relation(fields: [lessonId], references: [id])
  results  Result[]
}

model Assignment {
  id        Int      @id @default(autoincrement())
  title     String
  startDate DateTime
  dueDate   DateTime
  schoolId  Int
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  lessonId Int
  lesson   Lesson   @relation(fields: [lessonId], references: [id])
  results  Result[]
}

model Result {
  id       Int    @id @default(autoincrement())
  score    Int
  schoolId Int
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  examId       Int?
  exam         Exam?       @relation(fields: [examId], references: [id])
  assignmentId Int?
  assignment   Assignment? @relation(fields: [assignmentId], references: [id])
  studentId    Int
  student      Student     @relation(fields: [studentId], references: [id])
}

model Attendance {
  id       Int      @id @default(autoincrement())
  date     DateTime
  present  Boolean
  schoolId Int
  school   School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  studentId Int
  student   Student @relation(fields: [studentId], references: [id])
  lessonId  Int
  lesson    Lesson  @relation(fields: [lessonId], references: [id])
}

model Event {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  startTime   DateTime
  endTime     DateTime
  schoolId    Int
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  classId Int?
  class   Class? @relation(fields: [classId], references: [id])
}

model Announcement {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  date        DateTime
  schoolId    Int
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  classId Int?
  class   Class? @relation(fields: [classId], references: [id])
}

enum UserSex {
  MALE
  FEMALE
}

enum Day {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
}

enum ParentRelationship {
  FATHER
  MOTHER
  GUARDIAN
}

enum FeeFrequency {
  ONE_TIME
  MONTHLY
  QUARTERLY
  YEARLY
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  CHEQUE
  OTHER
}

enum FeeStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  WAIVED
}

model Fee {
  id        Int         @id @default(autoincrement())
  name      String
  amount    Float
  frequency FeeFrequency
  schoolId  Int
  school    School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  gradeId   Int?
  grade     Grade?      @relation(fields: [gradeId], references: [id])
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  studentFees StudentFee[]

  @@unique([name, gradeId, schoolId])
}

model StudentFee {
  id          Int       @id @default(autoincrement())
  studentId   Int
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  feeId       Int
  fee         Fee       @relation(fields: [feeId], references: [id])
  amount      Float
  dueDate     DateTime
  status      FeeStatus @default(PENDING)
  paidAmount  Float     @default(0)
  schoolId    Int
  school      School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear String?  // e.g., "2024-2025"
  term        String?   // e.g., "Fall", "Spring", "Summer"
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  feePayments FeePayment[]
}

model Payment {
  id              Int           @id @default(autoincrement())
  studentId       Int
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  amount          Float
  paymentDate     DateTime
  paymentMethod   PaymentMethod
  referenceNumber String?
  notes           String?
  schoolId        Int
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdBy       Int?          // Admin/Teacher ID who recorded the payment
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  feePayments     FeePayment[]
}

model FeePayment {
  id          Int        @id @default(autoincrement())
  paymentId   Int
  payment     Payment    @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  studentFeeId Int
  studentFee  StudentFee @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  amount      Float      // Portion of payment allocated to this fee
  createdAt   DateTime   @default(now())

  @@unique([paymentId, studentFeeId])
}
